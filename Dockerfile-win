# Use Python 3.11 slim image as base
FROM elice/python-nginx:3.11
#FROM python:3-trixie
#FROM ubuntu:noble

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Set work directory
WORKDIR /app

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        libpq-dev \
        curl \
        git \
        pandoc \
        texlive-latex-base \
        texlive-latex-recommended \
        texlive-fonts-recommended \
        lmodern \
        vim \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libgdk-pixbuf-2.0-0 \
        libffi-dev \
        shared-mime-info \
        libcairo2 \
        libpangoft2-1.0-0 \
        lsof \
        nginx \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better Docker layer caching
COPY requirements.txt .
COPY ./docker/nginx/api.jobtracknow.com.conf /etc/nginx/sites-available/api.jobtracknow.com.conf
COPY ./docker/nginx/api.jobtracknow.com-ssl.conf /etc/nginx/sites-available/api.jobtracknow.com-ssl.conf
COPY ./docker/ssl/* /etc/nginx/ssl/

# Install Python dependencies
#RUN pip install --no-cache-dir --upgrade pip \
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir git+https://github.com/dfop02/html4docx.git@1.1.1
RUN ln -s /etc/nginx/sites-available/api.jobtracknow.com.conf /etc/nginx/sites-enabled/ \
    && ln -s /etc/nginx/sites-available/api.jobtracknow.com-ssl.conf /etc/nginx/sites-enabled/ \
    && rm /etc/nginx/sites-enabled/default

# Copy application code
COPY . /app/

# Expose port
EXPOSE 7080
EXPOSE 443
EXPOSE 80

# Make wait script and start script executable
RUN chmod +x wait-for-db.py start-docker.sh

# Run uvicorn with multiple workers for concurrent request handling
# --workers 4: Run with 4 worker processes for parallel request processing
# Each worker can handle requests independently, preventing blocking
CMD ["nginx", "-g", "daemon off;"]